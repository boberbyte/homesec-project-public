# Filebeat Configuration for OpenWrt Router
# Note: Filebeat is not officially supported on OpenWrt
# Alternative: Use remote syslog to send logs to Rock Pi 4 SE
#
# This is a TEMPLATE - modify for actual deployment if Filebeat port becomes available

#================================ Filebeat Inputs =================================

filebeat.inputs:

# System logs
- type: log
  enabled: true
  paths:
    - /var/log/messages
  fields:
    log_type: system
    source: openwrt-router
    component: system
  fields_under_root: false

# Firewall logs (if logged to file)
- type: log
  enabled: true
  paths:
    - /var/log/firewall.log
  fields:
    log_type: firewall
    source: openwrt-router
    component: firewall
  fields_under_root: false

  # Parse firewall log format
  processors:
    - dissect:
        tokenizer: "%{timestamp} %{level} kernel: %{message}"
        field: "message"
        target_prefix: "fw"

# WireGuard logs
- type: log
  enabled: true
  paths:
    - /var/log/wireguard.log
  fields:
    log_type: vpn
    source: openwrt-router
    component: wireguard
  fields_under_root: false

# DHCP logs
- type: log
  enabled: true
  paths:
    - /var/log/dnsmasq.log
  fields:
    log_type: dhcp
    source: openwrt-router
    component: dnsmasq
  fields_under_root: false

#================================ Processors ======================================

processors:
  - add_host_metadata:
      geo:
        name: HomeSec-Router
        location: "VLAN 20"

#================================ Outputs =========================================

# Output to Elasticsearch via Rock Pi 4 SE or directly to server
output.elasticsearch:
  hosts: ["192.168.20.10:9200"]
  index: "homesec-firewall-%{+yyyy.MM.dd}"

  # Bulk settings (lower for resource-constrained OpenWrt)
  bulk_max_size: 256
  worker: 1

#================================ Index Template ==================================

setup.template.name: "homesec-firewall"
setup.template.pattern: "homesec-firewall-*"

#================================ Logging =========================================

logging.level: warning
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 3
  permissions: 0644

#================================ ALTERNATIVE: Remote Syslog ======================
#
# Since Filebeat may not be available for OpenWrt, use remote syslog instead:
#
# On OpenWrt router:
# uci set system.@system[0].log_ip='192.168.20.20'
# uci set system.@system[0].log_port='514'
# uci set system.@system[0].log_proto='udp'
# uci set system.@system[0].log_remote=1
# uci commit system
# /etc/init.d/log restart
#
# On Rock Pi 4 SE, configure rsyslog to receive and forward to Elasticsearch:
#
# /etc/rsyslog.d/10-openwrt.conf:
#
# # Load UDP module
# module(load="imudp")
# input(type="imudp" port="514")
#
# # Template for OpenWrt logs
# template(name="OpenwrtFormat" type="list") {
#     constant(value="{")
#     constant(value="\"@timestamp\":\"")      property(name="timereported" dateFormat="rfc3339")
#     constant(value="\",\"message\":\"")      property(name="msg")
#     constant(value="\",\"severity\":\"")     property(name="syslogseverity-text")
#     constant(value="\",\"facility\":\"")     property(name="syslogfacility-text")
#     constant(value="\",\"hostname\":\"")     property(name="hostname")
#     constant(value="\",\"source\":\"openwrt-router\"")
#     constant(value="}")
#     constant(value="\n")
# }
#
# # Write to file for Filebeat to pick up
# if $fromhost-ip == '192.168.20.1' then {
#     action(type="omfile" file="/var/log/openwrt/firewall.log" template="OpenwrtFormat")
# }
#
# Then configure Filebeat on Rock Pi 4 SE to read /var/log/openwrt/firewall.log
