//
// HomeSec BIND Configuration
// /etc/named.conf
//
// This configuration provides DNS services for all VLANs in the HomeSec infrastructure
//

// Access Control Lists
acl "trusted" {
    192.168.10.0/24;   // VLAN 10 - Trusted devices
    192.168.20.0/24;   // VLAN 20 - Infrastructure
    192.168.30.0/24;   // VLAN 30 - IoT/Guest
    192.168.40.0/24;   // VLAN 40 - Lab VMs
    192.168.99.0/24;   // VLAN 99 - Honeypot (monitored)
    127.0.0.1;         // localhost
    ::1;               // localhost IPv6
};

// Main Options
options {
    // Listen on all interfaces
    listen-on port 53 { 192.168.20.53; 127.0.0.1; };
    listen-on-v6 port 53 { ::1; };

    // Working directory
    directory       "/var/named";
    dump-file       "/var/named/data/cache_dump.db";
    statistics-file "/var/named/data/named_stats.txt";
    memstatistics-file "/var/named/data/named_mem_stats.txt";
    secroots-file   "/var/named/data/named.secroots";
    recursing-file  "/var/named/data/named.recursing";

    // Allow queries from trusted networks only
    allow-query { trusted; };

    // Recursion allowed for trusted networks
    recursion yes;
    allow-recursion { trusted; };

    // No zone transfers (we have no slaves)
    allow-transfer { none; };

    // DNSSEC configuration
    dnssec-enable yes;
    dnssec-validation auto;

    // Path to ISC DLV key
    managed-keys-directory "/var/named/dynamic";

    // PID file
    pid-file "/run/named/named.pid";
    session-keyfile "/run/named/session.key";

    // Forwarders (external DNS for recursive queries)
    forwarders {
        1.1.1.1;        // Cloudflare DNS
        1.0.0.1;        // Cloudflare DNS
        8.8.8.8;        // Google DNS (backup)
        8.8.4.4;        // Google DNS (backup)
    };
    forward first;

    // Rate limiting to prevent DNS amplification attacks
    rate-limit {
        responses-per-second 10;
        window 5;
    };

    // Cache settings
    max-cache-size 256M;
    max-cache-ttl 86400;     // 1 day
    max-ncache-ttl 3600;     // 1 hour for negative caching

    // Performance tuning
    recursive-clients 1000;
    tcp-clients 100;

    // Disable version disclosure for security
    version "DNS Server";
    hostname "dns.homesec.local";
};

// Logging configuration
logging {
    channel default_log {
        file "/var/log/named/named.log" versions 10 size 20m;
        severity info;
        print-time yes;
        print-severity yes;
        print-category yes;
    };

    channel query_log {
        file "/var/log/named/queries.log" versions 10 size 50m;
        severity info;
        print-time yes;
    };

    channel security_log {
        file "/var/log/named/security.log" versions 10 size 20m;
        severity info;
        print-time yes;
        print-severity yes;
    };

    category default { default_log; };
    category general { default_log; };
    category queries { query_log; };
    category security { security_log; };
    category lame-servers { null; };  // Don't log lame server warnings
};

// Root hints (for recursion)
zone "." IN {
    type hint;
    file "named.ca";
};

// Local zones
zone "localhost" IN {
    type master;
    file "named.localhost";
    allow-update { none; };
};

zone "0.0.127.in-addr.arpa" IN {
    type master;
    file "named.loopback";
    allow-update { none; };
};

zone "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.ip6.arpa" IN {
    type master;
    file "named.loopback";
    allow-update { none; };
};

// HomeSec internal zone (homesec.local)
zone "homesec.local" IN {
    type master;
    file "zones/db.homesec.local";
    allow-update { none; };
    allow-query { trusted; };
};

// Reverse zones for all VLANs

// VLAN 10 - Trusted devices (192.168.10.0/24)
zone "10.168.192.in-addr.arpa" IN {
    type master;
    file "zones/db.192.168.10";
    allow-update { none; };
    allow-query { trusted; };
};

// VLAN 20 - Infrastructure (192.168.20.0/24)
zone "20.168.192.in-addr.arpa" IN {
    type master;
    file "zones/db.192.168.20";
    allow-update { none; };
    allow-query { trusted; };
};

// VLAN 30 - IoT/Guest (192.168.30.0/24)
zone "30.168.192.in-addr.arpa" IN {
    type master;
    file "zones/db.192.168.30";
    allow-update { none; };
    allow-query { trusted; };
};

// VLAN 40 - Lab VMs (192.168.40.0/24)
zone "40.168.192.in-addr.arpa" IN {
    type master;
    file "zones/db.192.168.40";
    allow-update { none; };
    allow-query { trusted; };
};

// VLAN 99 - Honeypot DMZ (192.168.99.0/24)
zone "99.168.192.in-addr.arpa" IN {
    type master;
    file "zones/db.192.168.99";
    allow-update { none; };
    allow-query { trusted; };
};

// Include RNDC key for remote control
include "/etc/rndc.key";

controls {
    inet 127.0.0.1 port 953
        allow { 127.0.0.1; } keys { "rndc-key"; };
};
